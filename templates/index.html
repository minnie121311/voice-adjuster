<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Adjuster</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 40px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            max-width: 600px;
            width: 100%;
        }
        .progress-bar {
            background: #e0e0e0;
            height: 6px;
            border-radius: 3px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .progress-fill {
            background: #7c3aed;
            height: 100%;
            width: 33.33%;
            transition: width 0.3s;
        }
        .trial-info {
            text-align: center;
            font-size: 16px;
            color: #666;
            font-weight: 600;
            margin-bottom: 20px;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 26px;
            font-weight: 600;
        }
        .scenario-title {
            text-align: center;
            color: #7c3aed;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 30px;
        }
        .control-group {
            margin-bottom: 30px;
        }
        label {
            display: block;
            margin-bottom: 12px;
            color: #333;
            font-weight: 600;
            font-size: 15px;
        }
        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }
        #gender {
            background: linear-gradient(to right, #3b82f6 0%, #9333ea 50%, #ec4899 100%);
        }
        #pitch, #speed {
            background: #e0e0e0;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            border: 2px solid #7c3aed;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            border: 2px solid #7c3aed;
        }
        .value-display {
            text-align: center;
            font-size: 18px;
            color: #7c3aed;
            margin-top: 10px;
            font-weight: 600;
        }
        .gender-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #999;
            margin-top: 8px;
        }
        .buttons {
            display: flex;
            gap: 10px;
            margin-top: 40px;
        }
        button {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .btn-play {
            background: #9e9e9e;
            color: white;
        }
        .btn-play:hover:not(:disabled) {
            background: #757575;
        }
        .btn-stop {
            background: #e0e0e0;
            color: white;
        }
        .btn-stop:not(:disabled) {
            background: #616161;
        }
        .btn-stop:hover:not(:disabled) {
            background: #424242;
        }
        .btn-submit {
            background: #7c3aed;
            color: white;
        }
        .btn-submit:hover:not(:disabled) {
            background: #6d28d9;
        }
        .status {
            text-align: center;
            margin-top: 20px;
            color: #666;
            font-size: 14px;
            min-height: 25px;
        }
        .visualization {
            margin-top: 30px;
            display: none;
        }
        .visualization.active {
            display: block;
        }
        .visualization img {
            width: 100%;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }
        .completion-message {
            display: none;
            text-align: center;
            padding: 30px;
            background: #f0fdf4;
            border: 2px solid #86efac;
            border-radius: 6px;
            margin-top: 20px;
        }
        .completion-message.active {
            display: block;
        }
        .completion-message h2 {
            color: #059669;
            margin-bottom: 10px;
            font-size: 20px;
        }
        .completion-message p {
            color: #047857;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="progress-bar">
            <div class="progress-fill" id="progressBar"></div>
        </div>
        
        <div class="trial-info" id="trialInfo">Trial 1 of 3</div>
        
        <h1>Voice Adjuster</h1>
        
        <div class="scenario-title" id="scenarioTitle">Loading...</div>
        
        <div class="control-group">
            <label for="gender">Gender Spectrum</label>
            <input type="range" id="gender" min="-5" max="5" value="0" step="1">
            <div class="value-display" id="genderValue">Neutral (0)</div>
            <div class="gender-labels">
                <span>← Masculine</span>
                <span>Neutral</span>
                <span>Feminine →</span>
            </div>
        </div>

        <div class="control-group">
            <label for="pitch">Pitch Shift (Hz)</label>
            <input type="range" id="pitch" min="-50" max="50" value="0" step="1">
            <div class="value-display" id="pitchValue">0 Hz</div>
        </div>

        <div class="control-group">
            <label for="speed">Speed</label>
            <input type="range" id="speed" min="0.5" max="2.0" value="1.0" step="0.1">
            <div class="value-display" id="speedValue">1.0x</div>
        </div>

        <div class="buttons">
            <button class="btn-play" id="playBtn">▶︎ Play</button>
            <button class="btn-stop" id="stopBtn" disabled>◼︎ Stop</button>
            <button class="btn-submit" id="submitBtn">✔︎ Submit</button>
        </div>

        <div class="visualization" id="visualization">
            <img id="plotImage" src="" alt="Waveform & Pitch">
        </div>

        <div class="status" id="status"></div>
        
        <div class="completion-message" id="completionMessage">
            <h2>✔︎ All trials completed!</h2>
            <p>Your data has been saved. You can now proceed.</p>
        </div>
    </div>

    <script>
        // 원본 시나리오
        const scenariosOriginal = [
            {
                title: "Negative Message",
                audio: "negative.wav",
                type: "negative"
            },
            {
                title: "Positive Message",
                audio: "positive.wav",
                type: "positive"
            },
            {
                title: "Informational Message",
                audio: "informational.wav",
                type: "informational"
            }
        ];

        // Shuffle function (Fisher-Yates)
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // 랜덤 순서로 시나리오 설정
        const scenarios = shuffleArray(scenariosOriginal);
        const trialOrder = scenarios.map(s => s.type);

        let currentTrial = 0;
        let trialSubmitted = [false, false, false];
        let adjustedFilename = null;
        let currentAudio = null;

        const genderSlider = document.getElementById('gender');
        const pitchSlider = document.getElementById('pitch');
        const speedSlider = document.getElementById('speed');
        const genderValue = document.getElementById('genderValue');
        const pitchValue = document.getElementById('pitchValue');
        const speedValue = document.getElementById('speedValue');
        const playBtn = document.getElementById('playBtn');
        const stopBtn = document.getElementById('stopBtn');
        const submitBtn = document.getElementById('submitBtn');
        const status = document.getElementById('status');
        const visualization = document.getElementById('visualization');
        const plotImage = document.getElementById('plotImage');
        const progressBar = document.getElementById('progressBar');
        const trialInfo = document.getElementById('trialInfo');
        const scenarioTitle = document.getElementById('scenarioTitle');
        const completionMessage = document.getElementById('completionMessage');

        // Load scenario
        function loadScenario() {
            const scenario = scenarios[currentTrial];
            scenarioTitle.textContent = scenario.title;
            trialInfo.textContent = `Trial ${currentTrial + 1} of 3`;
            progressBar.style.width = `${((currentTrial + 1) / 3) * 100}%`;

            // Reset sliders
            genderSlider.value = 0;
            pitchSlider.value = 0;
            speedSlider.value = 1.0;
            genderValue.textContent = 'Neutral (0)';
            pitchValue.textContent = '0 Hz';
            speedValue.textContent = '1.0x';

            // Reset buttons
            submitBtn.disabled = trialSubmitted[currentTrial];
            status.textContent = trialSubmitted[currentTrial] ? '✔︎ Already submitted' : '';
            visualization.classList.remove('active');
        }

        // Gender slider
        genderSlider.addEventListener('input', (e) => {
            const value = parseInt(e.target.value);
            let label;
            if (value < 0) {
                label = `Masculine (${value})`;
            } else if (value > 0) {
                label = `Feminine (+${value})`;
            } else {
                label = 'Neutral (0)';
            }
            genderValue.textContent = label;
        });

        // Pitch slider
        pitchSlider.addEventListener('input', (e) => {
            pitchValue.textContent = e.target.value + ' Hz';
        });

        // Speed slider
        speedSlider.addEventListener('input', (e) => {
            speedValue.textContent = e.target.value + 'x';
        });

        // Play button
        playBtn.addEventListener('click', async () => {
            playBtn.disabled = true;
            status.textContent = 'Processing...';

            try {
                const response = await fetch('/adjust', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message_type: scenarios[currentTrial].type,
                        gender: genderSlider.value,
                        pitch: pitchSlider.value,
                        speed: speedSlider.value
                    })
                });

                const data = await response.json();
                adjustedFilename = data.output;

                currentAudio = new Audio(`/play/${adjustedFilename}?t=${Date.now()}`);
                
                currentAudio.addEventListener('ended', () => {
                    playBtn.disabled = false;
                    stopBtn.disabled = true;
                    status.textContent = '✔︎ Finished';
                });

                await currentAudio.play();
                stopBtn.disabled = false;

                plotImage.src = `/static/plots/${data.plot}?t=${Date.now()}`;
                visualization.classList.add('active');

                status.textContent = '▶︎ Playing...';
                
            } catch (error) {
                playBtn.disabled = false;
                stopBtn.disabled = true;
                status.textContent = '✖︎ Error processing audio';
                console.error(error);
            }
        });

        // Stop button
        stopBtn.addEventListener('click', () => {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                currentAudio = null;
            }
            playBtn.disabled = false;
            stopBtn.disabled = true;
            status.textContent = '◼︎ Stopped';
        });

        // Submit button
        submitBtn.addEventListener('click', async () => {
            if (trialSubmitted[currentTrial]) {
                alert('This trial has already been submitted.');
                return;
            }

            // 확인 알러트
            if (!confirm('Warning: You cannot change your adjustments after submission.\n\nAre you sure you want to submit?')) {
                return;
            }

            const dataToSave = {
                trial_number: currentTrial + 1,
                message_type: scenarios[currentTrial].type,
                gender: parseInt(genderSlider.value),
                pitch: parseInt(pitchSlider.value),
                speed: parseFloat(speedSlider.value),
                timestamp: new Date().toISOString()
            };

            try {
                // Railway 서버에 저장
                const response = await fetch('/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataToSave)
                });

                if (response.ok) {
                    // Gorilla로 데이터 전송
                    if (window.parent !== window) {
                        window.parent.postMessage({
                            type: 'voiceAdjustmentTrial',
                            trial_number: currentTrial + 1,
                            message_type: scenarios[currentTrial].type,
                            gender: parseInt(genderSlider.value),
                            pitch: parseInt(pitchSlider.value),
                            speed: parseFloat(speedSlider.value),
                            timestamp: dataToSave.timestamp
                        }, '*');
                    }
                    
                    trialSubmitted[currentTrial] = true;
                    submitBtn.disabled = true;
                    status.textContent = '✔︎ Submitted!';

                    // Check if all trials completed
                    if (trialSubmitted.every(submitted => submitted)) {
                        completionMessage.classList.add('active');
                        
                        if (window.parent !== window) {
                            window.parent.postMessage({
                                type: 'voiceAdjustmentComplete',
                                all_trials_completed: true,
                                trial_order: trialOrder
                            }, '*');
                        }
                    } else {
                        setTimeout(() => {
                            currentTrial++;
                            loadScenario();
                        }, 1500);
                    }
                } else {
                    alert('Error saving data. Please try again.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error submitting data. Please try again.');
            }
        });

        // Initialize
        console.log('Trial order:', trialOrder);
        loadScenario();
    </script>
</body>
</html>
